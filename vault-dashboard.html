<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Soomario — Max Pain Vault</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:wght@300;400;600&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root {
  /* ── COLOURS ───────────────────────────────────── */
  --bg:     #0b0917;
  --s1:     #13102a;
  --s2:     #1b183a;
  --s3:     #222045;
  --border: #32305a;
  --gold:   #e8c46a;
  --gold2:  #faefd4;
  --purple: #a89df0;
  --green:  #3ddc84;
  --red:    #ff6b6b;
  --cyan:   #22d3ee;
  --text:   #f4eedd;
  --dim:    #8880a8;
  --mid:    #c0b8d8;
  --radius: 10px;

  /* ══════════════════════════════════════════════════════════════
     FONT SIZES — all UI text sizes live here.
     Increase or decrease these numbers to rescale the dashboard.
     Current values are set at ~125% of the original design.
     ══════════════════════════════════════════════════════════════ */

  /* Navigation */
  --fs-nav-brand:  18px;    /* "SOOMARIO" wordmark */
  --fs-nav-sub:    10px;    /* "MAX PAIN VAULT" tagline */
  --fs-nav-link:   11px;    /* nav button text */
  --fs-live-pill:  11px;    /* LIVE / OFFLINE indicator */

  /* Metric cards */
  --fs-lbl:        11px;    /* card labels (VAULT EQUITY, WIN RATE…) */
  --fs-val-lg:     34px;    /* large values ($1,056, -$7.73) */
  --fs-val-md:     24px;    /* medium values (50%, 0.34) */
  --fs-val-sm:     18px;    /* small values in sidebar */
  --fs-sub:        15px;    /* sub-line beneath main value */
  --fs-note:       14px;    /* small note / warning line */

  /* Section headers */
  --fs-section:    12px;    /* section title (OPEN POSITIONS…) */
  --fs-section-ct: 11px;    /* right-side badge count */

  /* Table */
  --fs-tbl-hdr:    11px;    /* column header text */
  --fs-tbl-cell:   16px;    /* table body cells */
  --fs-coin:       17px;    /* coin symbol in table & trade rows */
  --fs-side:       11px;    /* LONG / SHORT badge */
  --fs-tbl-pnl:    16px;    /* unrealised PnL in table */

  /* Closed trade rows */
  --fs-trade-date:  12px;   /* date */
  --fs-trade-price: 15px;   /* entry price */
  --fs-trade-pnl:   15px;   /* realised PnL */

  /* Misc */
  --fs-vault-addr: 11px;    /* vault address string */
  --fs-vault-btn:  11px;    /* DEPOSIT / EXPLORER buttons */
  --fs-chart-note: 14px;    /* note below equity chart */
  --fs-empty:      17px;    /* empty-state placeholder */
  --fs-foot:       11px;    /* page footer */
}

/* ── RESET ── */
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Cormorant Garamond', serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  background-image:
    radial-gradient(ellipse 60% 40% at 15%  0%, rgba(124,111,207,.07) 0%, transparent 60%),
    radial-gradient(ellipse 40% 30% at 85% 100%, rgba(201,169, 97,.05) 0%, transparent 50%);
}

/* ── NAV ── */
.nav {
  display: flex; align-items: center; justify-content: space-between;
  padding: 18px 32px;
  background: rgba(11,9,23,.94);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 100;
}
.nav-brand { display: flex; align-items: center; gap: 14px; text-decoration: none; }
.nav-brand-text .t1 {
  font-family: 'Cinzel', serif;
  font-size: var(--fs-nav-brand); font-weight: 700;
  color: var(--text); letter-spacing: 2px; display: block;
}
.nav-brand-text .t2 {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--fs-nav-sub);
  color: var(--gold); letter-spacing: 3px; display: block; margin-top: 3px;
}
.nav-right { display: flex; align-items: center; gap: 16px; }
.live-pill {
  display: flex; align-items: center; gap: 8px;
  font-family: 'Orbitron', sans-serif;
  font-size: var(--fs-live-pill); color: var(--mid); letter-spacing: 2px;
}
.dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--green); box-shadow: 0 0 10px var(--green);
  animation: blink 2s ease-in-out infinite; transition: background .3s;
}
.dot.err { background: var(--red); box-shadow: 0 0 10px var(--red); }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.25} }

.nav-link {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--fs-nav-link);
  color: var(--mid); letter-spacing: 1.5px; text-decoration: none;
  padding: 7px 14px; border: 1px solid var(--border); border-radius: 7px;
  transition: all .2s;
}
.nav-link:hover { color: var(--gold); border-color: rgba(232,196,106,.5); }

/* ── MAIN ── */
.main { max-width: 1400px; margin: 0 auto; padding: 28px 28px 60px; }

/* ── ERROR BANNER ── */
.error-banner {
  background: rgba(255,107,107,.1); border: 1px solid rgba(255,107,107,.3);
  border-radius: var(--radius); padding: 14px 18px; margin-bottom: 16px;
  font-family: 'Orbitron', sans-serif;
  font-size: var(--fs-nav-link); color: var(--red);
  letter-spacing: 1px; display: none; align-items: center; gap: 10px;
}
.error-banner.show { display: flex; }

/* ── GRID ── */
.row { display: grid; gap: 14px; margin-bottom: 14px; }
.g4  { grid-template-columns: repeat(4, 1fr); }
.g21 { grid-template-columns: 2.2fr 1fr; }
.g1  { grid-template-columns: 1fr; }

/* ── CARD ── */
.card {
  background: var(--s1); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 22px 24px;
  position: relative; overflow: hidden;
}
.card-accent {
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--accent, var(--border)), transparent);
}

/* ── LABEL / VALUE / SUB / NOTE ── */
.lbl {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--fs-lbl); letter-spacing: 2px; text-transform: uppercase;
  color: var(--mid); margin-bottom: 12px;
}
.val {
  font-family: 'Orbitron', sans-serif; font-weight: 700;
  font-size: var(--fs-val-lg); line-height: 1.05; transition: color .3s;
}
.val.md { font-size: var(--fs-val-md); }
.val.sm { font-size: var(--fs-val-sm); }
/* No italics anywhere — sub and note use normal weight */
.sub  { font-size: var(--fs-sub);  color: var(--mid); margin-top: 9px; }
.note { font-size: var(--fs-note); color: var(--dim); margin-top: 8px; line-height: 1.5; }

/* ── COLOUR HELPERS ── */
.c-gold   { color: var(--gold)   !important; }
.c-green  { color: var(--green)  !important; }
.c-red    { color: var(--red)    !important; }
.c-cyan   { color: var(--cyan)   !important; }
.c-purple { color: var(--purple) !important; }
.c-mid    { color: var(--mid)    !important; }

/* ── SECTION TITLE ── */
.stitle {
  font-family: 'Cinzel', serif;
  font-size: var(--fs-section); font-weight: 600;
  letter-spacing: 2.5px; text-transform: uppercase; color: var(--gold2);
  margin-bottom: 18px; padding-bottom: 12px; border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
}
.stitle-count {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--fs-section-ct); color: var(--mid); font-weight: 400;
}

/* ── CHART TABS ── */
.chart-tabs { display: flex; gap: 4px; }
.ctab {
  font-family: 'Orbitron', sans-serif; font-size: 10px;
  letter-spacing: 1px; padding: 5px 12px;
  background: transparent; border: 1px solid var(--border);
  border-radius: 5px; color: var(--dim); cursor: pointer; transition: all .2s;
}
.ctab:hover  { color: var(--mid); border-color: var(--mid); }
.ctab.active { color: var(--gold); border-color: rgba(232,196,106,.5); background: rgba(232,196,106,.06); }


.chart-note { font-size: var(--fs-chart-note); color: var(--mid); margin-top: 12px; }

/* ── TABLE ── */
.tbl { width: 100%; border-collapse: collapse; }
.tbl th {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--fs-tbl-hdr); letter-spacing: 1.8px; text-transform: uppercase;
  color: var(--mid); padding: 8px 12px; text-align: left;
  border-bottom: 1px solid var(--border);
}
.tbl td {
  font-family: 'Cormorant Garamond', serif;
  font-size: var(--fs-tbl-cell);
  padding: 13px 12px; border-bottom: 1px solid rgba(50,48,90,.5);
}
.tbl tr:last-child td { border-bottom: none; }
.tbl tr:hover td { background: rgba(232,196,106,.03); }
.coin-label { font-family:'Cinzel',serif; font-weight:700; font-size:var(--fs-coin); color:var(--text); }
.side-long  { font-family:'Orbitron',sans-serif; font-size:var(--fs-side); font-weight:700; color:var(--green); letter-spacing:1px; }
.side-short { font-family:'Orbitron',sans-serif; font-size:var(--fs-side); font-weight:700; color:var(--red);   letter-spacing:1px; }
.tbl-pnl    { font-family:'Orbitron',sans-serif; font-size:var(--fs-tbl-pnl); font-weight:700; }
.tbl-lev    { font-family:'Orbitron',sans-serif; font-size:var(--fs-side); }

/* ── CLOSED TRADE ROWS ── */
.trades-wrap { max-height: 460px; overflow-y: auto; }
.trades-wrap::-webkit-scrollbar { width: 3px; }
.trades-wrap::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.trade-row {
  display: grid;
  grid-template-columns: 86px 64px 150px 1fr auto;
  gap: 12px; align-items: center;
  padding: 13px 16px;
  background: var(--s2); border: 1px solid var(--border);
  border-radius: 7px; margin-bottom: 6px; transition: background .15s;
}
.trade-row:hover { background: var(--s3); }
.trade-row:last-child { margin-bottom: 0; }
.t-coin  { font-family:'Cinzel',serif;              font-weight:700; font-size:var(--fs-coin);         color:var(--text); }
.t-side  { font-family:'Orbitron',sans-serif;       font-weight:700; font-size:var(--fs-side);         letter-spacing:1px; }
.t-date  { font-family:'Orbitron',sans-serif;                        font-size:var(--fs-trade-date);   color:var(--mid); }
.t-price { font-family:'Cormorant Garamond',serif;                   font-size:var(--fs-trade-price);  color:var(--mid); }
.t-pnl   { font-family:'Orbitron',sans-serif;       font-weight:700; font-size:var(--fs-trade-pnl);   text-align:right; }

/* ── SIDEBAR ── */
.mini-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.vault-addr {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--fs-vault-addr); color: var(--mid);
  word-break: break-all; line-height: 1.9; margin-top: 6px;
}
.vault-btn {
  display: block; text-align: center; margin-top: 12px;
  font-family: 'Orbitron', sans-serif; font-size: var(--fs-vault-btn);
  color: var(--gold); letter-spacing: 2px; text-decoration: none;
  padding: 12px 14px;
  border: 1px solid rgba(232,196,106,.4); border-radius: 7px;
  transition: all .2s;
}
.vault-btn:hover { background: rgba(232,196,106,.1); border-color: rgba(232,196,106,.7); }
.vault-btn.dim { color: var(--mid); border-color: var(--border); }
.vault-btn.dim:hover { background: rgba(192,184,216,.06); border-color: var(--mid); }

/* ── DIVIDER ── */
.divider {
  height: 1px; margin: 14px 0;
  background: linear-gradient(90deg, transparent, rgba(201,169,97,.2), transparent);
}

/* ── EMPTY ── */
.empty {
  text-align: center; padding: 28px 0;
  font-size: var(--fs-empty); color: var(--mid);
}

/* ── FOOTER ── */
.foot {
  font-family: 'Orbitron', sans-serif; font-size: var(--fs-foot);
  color: var(--mid); text-align: center; margin-top: 24px; letter-spacing: 1px;
}

/* ── RESPONSIVE ── */
@media(max-width:1100px) {
  .g4  { grid-template-columns: repeat(2,1fr); }
  .g21 { grid-template-columns: 1fr; }
}
@media(max-width:680px) {
  .main { padding: 14px 12px 40px; }
  .g4, .g21 { grid-template-columns: 1fr; }
  .trade-row { grid-template-columns: 76px 58px 1fr auto; }
  .t-date { display: none; }
}
</style>
</head>
<body>

<!-- ── NAV ─────────────────────────────────────────────────────────────── -->
<nav class="nav">
  <a class="nav-brand" href="index.html">
    <svg width="42" height="42" viewBox="0 0 48 48" fill="none">
      <circle cx="24" cy="24" r="22" stroke="#2a2145" stroke-width="1.5"/>
      <circle cx="24" cy="24" r="8"  stroke="#C9A961" stroke-width="1.5"/>
      <circle cx="24" cy="24" r="3"  fill="#C9A961"/>
      <line x1="24" y1="2"  x2="24" y2="10" stroke="#C9A961" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="24" y1="38" x2="24" y2="46" stroke="#C9A961" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="2"  y1="24" x2="10" y2="24" stroke="#C9A961" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="38" y1="24" x2="46" y2="24" stroke="#C9A961" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="7"  y1="7"  x2="13" y2="13" stroke="#7c6fcf" stroke-width="1" stroke-linecap="round"/>
      <line x1="35" y1="35" x2="41" y2="41" stroke="#7c6fcf" stroke-width="1" stroke-linecap="round"/>
      <line x1="41" y1="7"  x2="35" y2="13" stroke="#7c6fcf" stroke-width="1" stroke-linecap="round"/>
      <line x1="7"  y1="41" x2="13" y2="35" stroke="#7c6fcf" stroke-width="1" stroke-linecap="round"/>
    </svg>
    <div class="nav-brand-text">
      <span class="t1">SOOMARIO</span>
      <span class="t2">MAX PAIN VAULT</span>
    </div>
  </a>
  <div class="nav-right">
    <a class="nav-link" href="maxpain.html">← Strategy</a>
    <a class="nav-link" href="https://app.hyperliquid.xyz/vaults/0x843e160b4e7c453b38b14ac085a976db448d1b93" target="_blank">View on Hyperliquid ↗</a>
    <div class="live-pill">
      <div class="dot" id="dot"></div>
      <span id="live-ts">CONNECTING</span>
    </div>
  </div>
</nav>

<!-- ── MAIN ────────────────────────────────────────────────────────────── -->
<div class="main">

  <div class="error-banner" id="err-banner">
    ⚠ &nbsp;Could not reach Hyperliquid API — check your connection and refresh.
  </div>

  <!-- Row 1: Primary vault metrics -->
  <div class="row g4">
    <div class="card" style="--accent:var(--gold)">
      <div class="card-accent"></div>
      <div class="lbl">Vault Equity</div>
      <div class="val c-gold" id="equity">—</div>
      <div class="sub" id="depositors-sub">Loading…</div>
    </div>
    <div class="card" style="--accent:var(--green)">
      <div class="card-accent"></div>
      <div class="lbl">All-Time PnL</div>
      <div class="val" id="all-time-pnl">—</div>
      <div class="sub">Since vault inception</div>
    </div>
    <div class="card" style="--accent:var(--cyan)">
      <div class="card-accent"></div>
      <div class="lbl">Unrealised PnL</div>
      <div class="val" id="unrealised">—</div>
      <div class="sub" id="open-count-sub">— open positions</div>
    </div>
    <div class="card" style="--accent:var(--purple)">
      <div class="card-accent"></div>
      <div class="lbl">Total Closed Trades</div>
      <div class="val c-purple" id="total-trades">—</div>
      <div class="sub" id="realised-sub">Realised PnL: —</div>
    </div>
  </div>

  <!-- Row 2: Performance metrics -->
  <div class="row g4">
    <div class="card" style="--accent:var(--green)">
      <div class="card-accent"></div>
      <div class="lbl">Win Rate</div>
      <div class="val md" id="win-rate">—</div>
      <div class="sub" id="wr-sub">Closed trades</div>
      <div class="note" id="wr-note"></div>
    </div>
    <div class="card" style="--accent:var(--gold)">
      <div class="card-accent"></div>
      <div class="lbl">Profit Factor</div>
      <div class="val md c-gold" id="pf">—</div>
      <div class="sub" id="pf-sub">Gross wins / losses</div>
    </div>
    <div class="card" style="--accent:var(--cyan)">
      <div class="card-accent"></div>
      <div class="lbl">Avg Win</div>
      <div class="val md c-green" id="avg-win">—</div>
      <div class="sub" id="avg-loss-sub">Avg loss: —</div>
    </div>
    <div class="card" style="--accent:var(--purple)">
      <div class="card-accent"></div>
      <div class="lbl">Best / Worst Trade</div>
      <div class="val md c-green" id="best-trade">—</div>
      <div class="sub c-red" id="worst-trade">Worst: —</div>
    </div>
  </div>

  <!-- Row 3: Chart + sidebar -->
  <div class="row g21">
    <div class="card">
      <div class="stitle">
        <span id="chart-title">Vault Equity — Per Trade</span>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="stitle-count" id="curve-pts"></span>
          <div class="chart-tabs">
            <button class="ctab active" id="tab-trade" onclick="switchTab('trade')">Per Trade</button>
            <button class="ctab"        id="tab-live"  onclick="switchTab('live')">Live</button>
          </div>
        </div>
      </div>
      <div class="chart-wrap">
        <canvas id="chart-equity"></canvas>
      </div>
      <p class="chart-note" id="chart-note-text">
        Each point represents account equity after a closed trade — oldest to newest.
      </p>
    </div>

    <div class="card">
      <div class="stitle">Vault Details</div>
      <div class="mini-grid">
        <div>
          <div class="lbl">Depositors</div>
          <div class="val sm c-gold" id="dep-count">—</div>
        </div>
        <div>
          <div class="lbl">Profit Share</div>
          <div class="val sm c-gold">10%</div>
        </div>
        <div>
          <div class="lbl">Open Positions</div>
          <div class="val sm" id="open-pos-count">—</div>
        </div>
        <div>
          <div class="lbl">Strategy</div>
          <div class="val sm c-mid">v3.2</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="lbl">Vault Address</div>
      <div class="vault-addr">0x843e160b4e7c453b38b14ac085a976db448d1b93</div>
      <div class="divider"></div>
      <a class="vault-btn" href="https://app.hyperliquid.xyz/join/SMR" target="_blank">
        DEPOSIT INTO VAULT ↗
      </a>
      <a class="vault-btn dim" href="https://app.hyperliquid.xyz/vaults/0x843e160b4e7c453b38b14ac085a976db448d1b93" target="_blank">
        VIEW ON EXPLORER ↗
      </a>
    </div>
  </div>

  <!-- Row 4: Open Positions -->
  <div class="row g1">
    <div class="card">
      <div class="stitle">
        Open Positions
        <span class="stitle-count" id="pos-count-badge"></span>
      </div>
      <div style="overflow-x:auto">
        <table class="tbl">
          <thead>
            <tr>
              <th>Coin</th><th>Side</th><th>Size</th>
              <th>Entry Price</th><th>Notional</th>
              <th>Leverage</th><th>Unrealised PnL</th>
            </tr>
          </thead>
          <tbody id="pos-tbody">
            <tr><td colspan="7" class="empty">Loading positions…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Row 5: Closed Trades -->
  <div class="row g1">
    <div class="card">
      <div class="stitle">
        Closed Trades
        <span class="stitle-count" id="trades-count-badge">Most recent 100</span>
      </div>
      <div class="trades-wrap" id="trades-list">
        <div class="empty">Loading trade history…</div>
      </div>
    </div>
  </div>

  <div class="foot" id="foot-ts">
    Soomario Max Pain Vault · Data from Hyperliquid public API · Refreshes every 30s
  </div>

</div>

<script>
// ── CONFIG ────────────────────────────────────────────────────────────────
const VAULT     = '0x843e160b4e7c453b38b14ac085a976db448d1b93';
const HL_API    = 'https://api.hyperliquid.xyz/info';
const CURVE_KEY = 'smr_equity_curve';

// ── HYPERLIQUID API ───────────────────────────────────────────────────────
async function hlPost(payload) {
  const r = await fetch(HL_API, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}
async function fetchAll() {
  const [vault, state, fills] = await Promise.all([
    hlPost({ type: 'vaultDetails',       vaultAddress: VAULT }),
    hlPost({ type: 'clearinghouseState', user: VAULT }),
    hlPost({ type: 'userFills',          user: VAULT }),
  ]);
  return { vault, state, fills: Array.isArray(fills) ? fills : [] };
}

// ── PARSE ─────────────────────────────────────────────────────────────────
function parsePositions(state) {
  const out = [];
  try {
    for (const ap of (state.assetPositions || [])) {
      const pos  = ap.position || {};
      const size = parseFloat(pos.szi || 0);
      if (!size) continue;
      const entryPx   = parseFloat(pos.entryPx       || 0);
      const unrealPnl = parseFloat(pos.unrealizedPnl || 0);
      const lev       = pos.leverage?.value ?? pos.leverage ?? '?';
      const notional  = Math.abs(size) * entryPx;
      const pnlPct    = notional > 0 ? unrealPnl / notional * 100 : 0;
      out.push({ coin: pos.coin || '?', side: size > 0 ? 'LONG' : 'SHORT',
                 size: Math.abs(size), entryPx, notional, unrealPnl, lev,
                 pnlPct: round(pnlPct, 2) });
    }
  } catch {}
  return out;
}

function parseFills(fills) {
  const orders = {};
  for (const f of fills) {
    const oid = String(f.oid || f.orderId || '');
    if (!oid) continue;
    const dir = f.dir || '';
    if (!orders[oid]) {
      orders[oid] = { coin: f.coin || '?',
                      side: dir.includes('Long') ? 'LONG' : 'SHORT',
                      pnl: 0, px: parseFloat(f.px || 0),
                      time: f.time || 0, isClose: false };
    }
    if (dir.includes('Close')) {
      orders[oid].pnl    += parseFloat(f.closedPnl || 0);
      orders[oid].isClose = true;
    }
  }
  return Object.values(orders)
    .filter(t => t.isClose)
    .sort((a, b) => b.time - a.time);
}

function calcMetrics(closed) {
  const pnls = closed.map(t => t.pnl).filter(p => p !== 0);
  const n = pnls.length;
  if (!n) return null;
  const wins   = pnls.filter(p => p > 0);
  const losses = pnls.filter(p => p < 0);
  const gw = wins.reduce((a,b)=>a+b,0);
  const gl = Math.abs(losses.reduce((a,b)=>a+b,0));
  let pf = null;
  if (gl > 0) pf = round(gw / gl, 2);
  else if (gw > 0) pf = 999;
  return {
    total:    n,
    totalPnl: round(pnls.reduce((a,b)=>a+b,0), 2),
    winRate:  round(wins.length / n * 100, 1),
    avgWin:   wins.length   ? round(gw / wins.length, 2) : 0,
    avgLoss:  losses.length ? round(losses.reduce((a,b)=>a+b,0) / losses.length, 2) : 0,
    best:     round(Math.max(...pnls), 2),
    worst:    round(Math.min(...pnls), 2),
    pf,
    note: n < 10 ? `Only ${n} closed trades — ratios stabilise at 10+` : '',
  };
}

// ── EQUITY CURVE (localStorage — live snapshots) ──────────────────────────
function getCurve() {
  try { return JSON.parse(localStorage.getItem(CURVE_KEY) || '[]'); } catch { return []; }
}
function pushCurve(equity) {
  const curve = getCurve();
  const label = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  if (curve.length && curve[curve.length-1].t === label) {
    curve[curve.length-1].v = equity;
  } else {
    curve.push({t: label, v: equity});
  }
  const trimmed = curve.slice(-200);
  try { localStorage.setItem(CURVE_KEY, JSON.stringify(trimmed)); } catch {}
  return trimmed;
}

// ── PER-TRADE EQUITY CURVE ────────────────────────────────────────────────
// Builds equity progression from closed trades (oldest → newest).
// Starting equity = current equity - unrealised - total realised PnL
function buildTradeChart(closed, currentEquity, unrealised) {
  if (!closed.length) return { labels: [], data: [] };

  // Sort oldest → newest
  const sorted = [...closed].sort((a, b) => a.time - b.time);

  // Reconstruct starting equity
  const totalRealised = sorted.reduce((s, t) => s + t.pnl, 0);
  const startEquity   = currentEquity - unrealised - totalRealised;

  const labels = [];
  const data   = [];
  let running  = startEquity;

  // Add start point
  labels.push('Start');
  data.push(round(running, 2));

  for (const t of sorted) {
    running += t.pnl;
    const d  = new Date(t.time);
    const lbl = d.toLocaleDateString('en-US', {month:'short', day:'numeric'}) + ' ' +
                d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    labels.push(`${t.coin} (${t.side})\n${lbl}`);
    data.push(round(running, 2));
  }

  return { labels, data };
}

// ── CHART ─────────────────────────────────────────────────────────────────
let chartInst = null;
let activeTab = 'trade';   // 'trade' | 'live'
let lastClosed   = [];
let lastEquity   = 0;
let lastUnreal   = 0;
let lastLiveCurve = [];

function switchTab(tab) {
  activeTab = tab;
  document.getElementById('tab-trade').classList.toggle('active', tab === 'trade');
  document.getElementById('tab-live').classList.toggle('active',  tab === 'live');

  if (tab === 'trade') {
    document.getElementById('chart-title').textContent = 'Vault Equity — Per Trade';
    document.getElementById('chart-note-text').textContent =
      'Each point represents account equity after a closed trade — oldest to newest.';
    const { labels, data } = buildTradeChart(lastClosed, lastEquity, lastUnreal);
    updateChart(labels, data, labels.length <= 30);
    document.getElementById('curve-pts').textContent =
      data.length > 1 ? (data.length - 1) + ' trade' + (data.length - 1 !== 1 ? 's' : '') : 'Waiting for trades';
  } else {
    document.getElementById('chart-title').textContent = 'Vault Equity — Live Snapshots';
    document.getElementById('chart-note-text').textContent =
      'Snapshots saved every 30 seconds in your browser via localStorage.';
    updateChart(lastLiveCurve.map(p => p.t), lastLiveCurve.map(p => p.v), lastLiveCurve.length <= 30);
    document.getElementById('curve-pts').textContent =
      lastLiveCurve.length + ' snapshot' + (lastLiveCurve.length !== 1 ? 's' : '') + ' this session';
  }
}

function updateChart(labels, data, showPoints) {
  const ctx = document.getElementById('chart-equity').getContext('2d');

  if (chartInst) {
    chartInst.data.labels = labels;
    chartInst.data.datasets[0].data = data;
    chartInst.data.datasets[0].pointRadius = showPoints ? 4 : 0;
    chartInst.update('none');
    return;
  }

  const grad = ctx.createLinearGradient(0, 0, 0, 210);
  grad.addColorStop(0,  'rgba(232,196,106,.22)');
  grad.addColorStop(.7, 'rgba(232,196,106,.03)');
  grad.addColorStop(1,  'rgba(232,196,106,0)');

  chartInst = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{
      data, borderColor: '#e8c46a', borderWidth: 2,
      backgroundColor: grad, fill: true, tension: 0.35,
      pointRadius: showPoints ? 4 : 0,
      pointHoverRadius: 6, pointBackgroundColor: '#e8c46a',
      pointBorderColor: '#13102a', pointBorderWidth: 2,
    }]},
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 400 },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#13102a', borderColor: '#32305a', borderWidth: 1,
          titleColor: '#8880a8', bodyColor: '#f4eedd',
          titleFont: {family:'Orbitron', size:10},
          bodyFont:  {family:'Orbitron', size:13},
          callbacks: {
            title: items => items[0].label.replace('\n', ' — '),
            label: c => ' $' + c.parsed.y.toLocaleString('en-US', {minimumFractionDigits:2})
          }
        }
      },
      scales: {
        x: { grid:  {color:'rgba(50,48,90,.6)', drawBorder:false},
             ticks: {color:'#8880a8', font:{family:'Orbitron',size:9}, maxTicksLimit:8,
                     callback: (v, i, arr) => {
                       // For per-trade: show coin name only
                       const lbl = chartInst?.data.labels[i] || '';
                       const first = lbl.split('\n')[0];
                       return first.length > 12 ? first.substring(0,12) : first;
                     }} },
        y: { grid:  {color:'rgba(50,48,90,.6)', drawBorder:false},
             ticks: {color:'#8880a8', font:{family:'Orbitron',size:10},
                     callback: v => '$'+v.toLocaleString()} }
      }
    }
  });
}


// ── HELPERS ───────────────────────────────────────────────────────────────
const round  = (n, d=2) => Math.round(n * 10**d) / 10**d;
const fmt    = (n, d=2) => n == null ? '—' :
  Math.abs(n).toLocaleString('en-US', {minimumFractionDigits:d, maximumFractionDigits:d});
const col    = n => n >= 0 ? 'var(--green)' : 'var(--red)';
const fmtUsd = (n, d=2) => (n >= 0 ? '+' : '−') + '$' + fmt(n, d);

function set(id, text, color) {
  const el = document.getElementById(id);
  if (!el) return;
  if (text  !== undefined) el.textContent = text;
  if (color !== undefined) el.style.color = color;
}
function fmtDate(ms) {
  if (!ms) return '—';
  const d = new Date(ms);
  return d.toLocaleDateString('en-US', {month:'short', day:'numeric'}) + ' ' +
         d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

// ── RENDER ────────────────────────────────────────────────────────────────
function render({ vault, state, fills }) {
  let equity = 0, allTimePnl = 0, depositors = 0;
  try {
    equity     = parseFloat(vault.vaultEquity || 0);
    allTimePnl = parseFloat(vault.allTimePnl  || 0);
    depositors = (vault.depositors || []).length;
  } catch {}
  if (!equity) {
    try { equity = parseFloat(state.crossMarginSummary?.accountValue || 0); } catch {}
  }

  const positions  = parsePositions(state);
  const unrealised = positions.reduce((a,p) => a + p.unrealPnl, 0);
  const closed     = parseFills(fills);
  const metrics    = calcMetrics(closed);

  // If API returns 0 for allTimePnl, compute from fills + unrealised
  if (allTimePnl === 0 && metrics && metrics.totalPnl !== 0) {
    allTimePnl = round(metrics.totalPnl + unrealised, 2);
  }

  // Store for tab switching
  lastClosed    = closed;
  lastEquity    = equity;
  lastUnreal    = unrealised;

  // Live snapshot
  if (equity > 0) lastLiveCurve = pushCurve(equity);

  // Render active chart tab
  if (activeTab === 'trade') {
    const { labels, data } = buildTradeChart(closed, equity, unrealised);
    updateChart(labels, data, data.length <= 30);
    document.getElementById('curve-pts').textContent =
      data.length > 1 ? (data.length - 1) + ' trade' + (data.length - 1 !== 1 ? 's' : '') : 'Waiting for trades';
  } else {
    updateChart(lastLiveCurve.map(p => p.t), lastLiveCurve.map(p => p.v), lastLiveCurve.length <= 30);
    document.getElementById('curve-pts').textContent =
      lastLiveCurve.length + ' snapshot' + (lastLiveCurve.length !== 1 ? 's' : '') + ' this session';
  }

  // Row 1
  set('equity',         '$' + fmt(equity),   'var(--gold)');
  set('depositors-sub', depositors + ' depositors');
  set('dep-count',      depositors || '—');
  set('all-time-pnl',   fmtUsd(allTimePnl),  col(allTimePnl));
  set('unrealised',     fmtUsd(unrealised),   col(unrealised));
  set('open-count-sub', positions.length + ' open position' + (positions.length !== 1 ? 's' : ''));
  set('open-pos-count', positions.length || '—');

  // Row 2
  if (metrics) {
    set('total-trades', metrics.total);
    set('realised-sub', 'Realised PnL: ' + fmtUsd(metrics.totalPnl));
    set('win-rate', metrics.winRate + '%',
        metrics.winRate >= 70 ? 'var(--green)' : metrics.winRate >= 50 ? 'var(--gold)' : 'var(--red)');
    set('wr-sub',  metrics.total + ' closed trades');
    set('wr-note', metrics.note || '');
    set('pf', metrics.pf === 999 ? '∞' : metrics.pf != null ? String(metrics.pf) : '—',
        metrics.pf >= 2 ? 'var(--green)' : metrics.pf >= 1 ? 'var(--gold)' : 'var(--red)');
    set('pf-sub', metrics.pf === 999 ? 'All wins, no losses'  :
                  metrics.pf >= 2    ? 'Excellent (>2.0)'     :
                  metrics.pf >= 1.5  ? 'Good (>1.5)'          :
                  metrics.pf >= 1    ? 'Profitable (>1.0)'    : 'Unprofitable');
    set('avg-win',      metrics.avgWin  > 0 ? '+$' + fmt(metrics.avgWin)              : '—', 'var(--green)');
    set('avg-loss-sub', metrics.avgLoss < 0 ? 'Avg loss: −$' + fmt(Math.abs(metrics.avgLoss)) : 'Avg loss: —');
    set('best-trade',   metrics.best  > 0   ? '+$' + fmt(metrics.best)                : '—', 'var(--green)');
    set('worst-trade',  metrics.worst < 0   ? 'Worst: −$' + fmt(Math.abs(metrics.worst)) : 'Worst: —', 'var(--red)');
  } else {
    set('total-trades', '—');
    set('realised-sub', 'No closed trades yet');
  }

  // Open positions
  const posBody = document.getElementById('pos-tbody');
  document.getElementById('pos-count-badge').textContent =
    positions.length ? positions.length + ' active' : '';
  if (!positions.length) {
    posBody.innerHTML = '<tr><td colspan="7" class="empty">No open positions right now</td></tr>';
  } else {
    posBody.innerHTML = positions.map(p => `
      <tr>
        <td><span class="coin-label">${p.coin}</span></td>
        <td><span class="${p.side==='LONG'?'side-long':'side-short'}">${p.side}</span></td>
        <td>${p.size.toFixed(4)}</td>
        <td>$${fmt(p.entryPx, 4)}</td>
        <td>$${fmt(p.notional)}</td>
        <td class="tbl-lev">${p.lev}x</td>
        <td class="tbl-pnl" style="color:${col(p.unrealPnl)}">
          ${fmtUsd(p.unrealPnl)}
          <span style="font-size:var(--fs-side);opacity:.7"> (${p.pnlPct>=0?'+':'−'}${Math.abs(p.pnlPct)}%)</span>
        </td>
      </tr>`).join('');
  }

  // Closed trades
  document.getElementById('trades-count-badge').textContent =
    closed.length ? closed.length + ' trades loaded' : '';
  const tradesList = document.getElementById('trades-list');
  if (!closed.length) {
    tradesList.innerHTML = '<div class="empty">No closed trades found. History builds over time as Hyperliquid returns fills.</div>';
  } else {
    tradesList.innerHTML = closed.slice(0, 100).map(t => `
      <div class="trade-row">
        <span class="t-coin">${t.coin}</span>
        <span class="t-side ${t.side==='LONG'?'c-green':'c-red'}">${t.side}</span>
        <span class="t-date">${fmtDate(t.time)}</span>
        <span class="t-price">@ $${fmt(t.px, 4)}</span>
        <span class="t-pnl" style="color:${col(t.pnl)}">${fmtUsd(t.pnl)}</span>
      </div>`).join('');
  }

  // Status
  document.getElementById('dot').classList.remove('err');
  document.getElementById('live-ts').textContent = 'LIVE';
  document.getElementById('err-banner').classList.remove('show');
  document.getElementById('foot-ts').textContent =
    'Last updated: ' + new Date().toLocaleTimeString() +
    '  ·  Soomario Max Pain Vault  ·  Live data via Hyperliquid public API';
}

// ── MAIN LOOP ─────────────────────────────────────────────────────────────
async function refresh() {
  try {
    render(await fetchAll());
  } catch (err) {
    console.error('Dashboard error:', err);
    document.getElementById('dot').classList.add('err');
    document.getElementById('live-ts').textContent = 'OFFLINE';
    document.getElementById('err-banner').classList.add('show');
  }
}

const storedCurve = getCurve();
// Boot the live curve from localStorage so it renders immediately on page load
if (storedCurve.length > 1) {
  lastLiveCurve = storedCurve;
  // Default tab is 'trade' — chart will populate on first refresh() call
}

refresh();
setInterval(refresh, 30_000);
</script>
</body>
</html>
